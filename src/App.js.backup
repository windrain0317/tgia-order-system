import React, { useState, useRef } from 'react';
import { AlertCircle, Download, Send, Plus, Edit3, Check, X, RotateCcw, Upload } from 'lucide-react';

// ========== ç°½åæ¿çµ„ä»¶ ==========
const SignaturePad = ({ onSave, onCancel, title = "è«‹ç°½å" }) => {
  const canvasRef = useRef(null);
  const fileInputRef = useRef(null);
  const [isDrawing, setIsDrawing] = useState(false);
  const [isEmpty, setIsEmpty] = useState(true);
  const [context, setContext] = useState(null);
  const [uploadMode, setUploadMode] = useState('draw');

  React.useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * window.devicePixelRatio;
    canvas.height = rect.height * window.devicePixelRatio;
    
    const ctx = canvas.getContext('2d');
    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    ctx.strokeStyle = '#000000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    setContext(ctx);
    
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }, []);

  const getCoordinates = (e) => {
    const canvas = canvasRef.current;
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return {
      x: clientX - rect.left,
      y: clientY - rect.top
    };
  };

  const startDrawing = (e) => {
    e.preventDefault();
    setIsDrawing(true);
    setIsEmpty(false);
    const { x, y } = getCoordinates(e);
    context.beginPath();
    context.moveTo(x, y);
  };

  const draw = (e) => {
    e.preventDefault();
    if (!isDrawing) return;
    const { x, y } = getCoordinates(e);
    context.lineTo(x, y);
    context.stroke();
  };

  const stopDrawing = (e) => {
    e.preventDefault();
    setIsDrawing(false);
    context.closePath();
  };

  const clearSignature = () => {
    const canvas = canvasRef.current;
    const rect = canvas.getBoundingClientRect();
    context.fillStyle = '#FFFFFF';
    context.fillRect(0, 0, rect.width, rect.height);
    setIsEmpty(true);
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          const canvas = canvasRef.current;
          const rect = canvas.getBoundingClientRect();
          context.fillStyle = '#FFFFFF';
          context.fillRect(0, 0, rect.width, rect.height);
          
          const scale = Math.min(rect.width / img.width, rect.height / img.height);
          const x = (rect.width - img.width * scale) / 2;
          const y = (rect.height - img.height * scale) / 2;
          
          context.drawImage(img, x, y, img.width * scale, img.height * scale);
          setIsEmpty(false);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  };

  const saveSignature = () => {
    if (isEmpty) {
      alert('è«‹å…ˆç°½åæˆ–ä¸Šå‚³åœ–ç‰‡');
      return;
    }
    const canvas = canvasRef.current;
    const signatureData = canvas.toDataURL('image/png');
    onSave(signatureData);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full">
        <div className="border-b px-6 py-4 flex items-center justify-between">
          <h3 className="text-lg font-semibold text-gray-800">{title}</h3>
          <button onClick={onCancel} className="text-gray-400 hover:text-gray-600 transition">
            <X size={24} />
          </button>
        </div>
        
        <div className="p-6">
          <div className="flex gap-2 mb-4">
            <button
              onClick={() => setUploadMode('draw')}
              className={`flex-1 py-2 px-4 rounded-lg transition ${
                uploadMode === 'draw' 
                  ? 'bg-blue-600 text-white' 
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              <Edit3 size={16} className="inline mr-2" />
              æ‰‹å¯«ç°½å
            </button>
            <button
              onClick={() => setUploadMode('upload')}
              className={`flex-1 py-2 px-4 rounded-lg transition ${
                uploadMode === 'upload' 
                  ? 'bg-blue-600 text-white' 
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              <Upload size={16} className="inline mr-2" />
              ä¸Šå‚³åœ–ç‰‡
            </button>
          </div>

          <div className="border-2 border-dashed border-gray-300 rounded-lg bg-white overflow-hidden">
            <canvas
              ref={canvasRef}
              className="w-full touch-none cursor-crosshair"
              style={{ height: '300px' }}
              onMouseDown={uploadMode === 'draw' ? startDrawing : undefined}
              onMouseMove={uploadMode === 'draw' ? draw : undefined}
              onMouseUp={uploadMode === 'draw' ? stopDrawing : undefined}
              onMouseLeave={uploadMode === 'draw' ? stopDrawing : undefined}
              onTouchStart={uploadMode === 'draw' ? startDrawing : undefined}
              onTouchMove={uploadMode === 'draw' ? draw : undefined}
              onTouchEnd={uploadMode === 'draw' ? stopDrawing : undefined}
            />
          </div>
          
          {uploadMode === 'draw' ? (
            <p className="text-sm text-gray-500 mt-2 text-center">
              ğŸ’¡ æç¤ºï¼šä½¿ç”¨æ»‘é¼ ã€è§¸æ§ç­†æˆ–æ‰‹æŒ‡åœ¨ä¸Šæ–¹å€åŸŸç°½å
            </p>
          ) : (
            <div className="mt-4">
              <input
                ref={fileInputRef}
                type="file"
                accept="image/*"
                onChange={handleFileUpload}
                className="hidden"
              />
              <button
                onClick={() => fileInputRef.current?.click()}
                className="w-full py-3 border-2 border-dashed border-blue-300 rounded-lg hover:bg-blue-50 transition text-blue-600 font-medium"
              >
                <Upload size={20} className="inline mr-2" />
                é»æ“Šé¸æ“‡åœ–ç‰‡æª”æ¡ˆ
              </button>
              <p className="text-sm text-gray-500 mt-2 text-center">
                æ”¯æ´ JPGã€PNG ç­‰åœ–ç‰‡æ ¼å¼
              </p>
            </div>
          )}
        </div>
        
        <div className="border-t px-6 py-4 flex gap-3 justify-end">
          <button
            onClick={clearSignature}
            className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center gap-2"
          >
            <RotateCcw size={18} />
            æ¸…é™¤
          </button>
          <button
            onClick={onCancel}
            className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
          >
            å–æ¶ˆ
          </button>
          <button
            onClick={saveSignature}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
          >
            <Check size={18} />
            ç¢ºèªç°½å
          </button>
        </div>
      </div>
    </div>
  );
};

// ========== ä¸»è¡¨å–®çµ„ä»¶ ==========
const TGIAOrderForm = () => {
  const [showOrgSuggestions, setShowOrgSuggestions] = useState(false);
  const [filteredOrgs, setFilteredOrgs] = useState([]);
  
  const organizationOptions = [
    'åœ‹ç«‹é™½æ˜äº¤é€šå¤§å­¸',
    'åœ‹ç«‹å°ç£å¤§å­¸',
    'åœ‹ç«‹æˆåŠŸå¤§å­¸'
  ];

  const salesPersonOptions = [
    'è«‹é¸æ“‡æ¥­å‹™äººå“¡',
    'å¼µä¸‰',
    'æå››',
    'ç‹äº”'
  ];

  const [formData, setFormData] = useState({
    salesPerson: '',
    organization: '',
    principalInvestigator: '',
    contactPerson: '',
    contactPhone: '',
    email: '',
    address: '',
    invoiceTitle: '',
    taxId: '',
    invoiceCopies: 'äºŒè¯å¼',
    dataDeliveryMethod: 'HDDç”±å°ˆäººéé€',
    nchcAccount: '',
    deliveryAddress: '',
    recipient: '',
    recipientPhone: '',
    recipientEmail: '',
    serviceItems: [{
      category: 'è«‹é¸æ“‡æœå‹™é¡åˆ¥',
      services: [{ service: '', quantity: '' }],
      libraryType: 'ç„¡',
      seqSpec: ''
    }],
    sampleType: 'ç„¡é€æ¨£',
    sampleTypeOther: '',
    libraryInfo: {
      sampleSheet: [{
        no: 1,
        sampleName: '',
        tubeLabel: '',
        conc: '',
        vol: '',
        ngsConc: '',
        expectedSeq: '',
        note: ''
      }],
      runConfig: {
        sequencer: 'ä¸é™',
        read1Length: '151bp',
        read2Length: '151bp',
        phiX: '1%'
      },
      librarySampleSheet: [{
        no: 1,
        sampleName: '',
        libraryPrepKit: '',
        indexAdapterKit: '',
        setWellPosition: '',
        index1Seq: '',
        index2Seq: '',
        note: '',
        library: ''
      }],
      gelImage: ''
    },
    sampleInfo: {
      sampleSheet: [{
        no: 1,
        sampleName: '',
        tubeLabel: '',
        expectedSeq: '',
        concMethod: '',
        conc: '',
        vol: '',
        ratio260280: '',
        ratio260230: '',
        dqnRqn: '',
        note: ''
      }]
    },
    preservationMethod: 'Nuclease-free H2O',
    preservationMethodOther: '',
    sampleCount: '',
    species: 'ç‰©ç¨®è«‹é¸æ“‡',
    speciesOther: '',
    shippingMethod: 'å†·å‡(ä¹¾å†°)',
    shippingMethodOther: '',
    sampleReturn: 'ä¸éœ€è¦',
    notes: '',
    signature: null
  });

  const [submitted, setSubmitted] = useState(false);
  const [message, setMessage] = useState('');
  const [orderId, setOrderId] = useState('');
  const [showSignaturePad, setShowSignaturePad] = useState(false);
  const [showPasteModal, setShowPasteModal] = useState(false);
  const [pasteMode, setPasteMode] = useState('sampleSheet');
  const [pasteData, setPasteData] = useState('');
  const excelUploadRef = useRef(null);
  const sampleExcelUploadRef = useRef(null);

  const serviceCategories = [
    'è«‹é¸æ“‡æœå‹™é¡åˆ¥',
    'å®šåºæœå‹™ (S)',
    'å»ºåº«æœå‹™ (L)',
    'èƒå–/QC (Q)',
    'åˆ†ææœå‹™ (A1)',
    'åˆ†ææœå‹™ (A2)',
    'åˆ†ææœå‹™ (A3)',
    'å€Ÿå‡ºè©¦åŠ‘ (R)',
    'å¯¦é©—æœå‹™å¤–åŒ… (OS)',
    'å°åŸºå®‰WGSåŒ…å¥—1',
    'å°åŸºå®‰WGSåŒ…å¥—2',
    'å°åŸºå®‰WGSåŒ…å¥—3',
    'å°åŸºå®‰WESåŒ…å¥—1',
    'å°åŸºå®‰WESåŒ…å¥—2',
    'å°åŸºå®‰WESåŒ…å¥—3',
    'RNAseq-BasicåŒ…å¥—',
    'RNAseq-AdvancedåŒ…å¥—'
  ];

  const serviceOptionsByCategory = {
    'å®šåºæœå‹™ (S)': [
      'S-0000 ç„¡å®šåº',
      'S-G001 äºŒä»£å®šåº',
      'S-G002 äºŒä»£å®šåº',
      'S-LN01 äºŒä»£å®šåº',
      'S-LN02 äºŒä»£å®šåº',
      'S-LN03 äºŒä»£å®šåº',
      'S-FC01 äºŒä»£å®šåº',
      'S-FC02 äºŒä»£å®šåº',
      'S-OS01 ä¸‰ä»£å®šåº',
      'S-OS02 ä¸‰ä»£å®šåº',
      'S-OS03 ä¸‰ä»£å®šåº',
      'S-OS04 å…§éƒ¨ä½¿ç”¨'
    ],
    'å»ºåº«æœå‹™ (L)': [
      'L-0000 ç„¡å»ºåº«',
      'L-TA01 TAF èªè­‰',
      'L-TA02 TAF èªè­‰',
      'L-WE01 WES',
      'L-WE02 WES',
      'L-WE03 WES',
      'L-WE04 WES',
      'L-WG01 WGS',
      'L-WG02 WGS',
      'L-WG03 WGS',
      'L-WG04 WGBS',
      'L-TS01 TSO500',
      'L-TS02 å…§éƒ¨ä½¿ç”¨',
      'L-TS03 TSO500',
      'L-TS04 å…§éƒ¨ä½¿ç”¨',
      'L-DN01 å…§éƒ¨ä½¿ç”¨',
      'L-RN01 RNAseq',
      'L-RN02 RNAseq',
      'L-RN03 RNAseq',
      'L-RN04 RNAseq',
      'L-RN05 RNAseq',
      'L-RN06 RNAseq',
      'L-RN07 RNAseq',
      'L-RN08 RNAseq',
      'L-PB01 PacBio',
      'L-PB02 PacBio',
      'L-PB03 PacBio',
      'L-PB04 PacBio',
      'L-PB05 PacBio',
      'L-PB06 PacBio',
      'L-OS01 10x',
      'L-OS02 10x',
      'L-OS03 10x',
      'L-OS04 10x',
      'L-OS05 10x'
    ],
    'èƒå–/QC (Q)': [
      'Q-0000 ç„¡èƒå–',
      'Q-QC01 DNA QC',
      'Q-QC02 DNA QC(PacBio)',
      'Q-QC03 RNA QC',
      'Q-QC04 RNA QC(PacBio)ä½¿ç”¨',
      'Q-QC05 Library QC',
      'Q-QC06 Library QC(PacBio)',
      'Q-ED01 DNAèƒå–+QC - è¡€æ¶²ã€Buffy coat DNAèƒå–',
      'Q-ED02 DNAèƒå–+QC - ç´°èƒ DNAèƒå–' ,
      'Q-ED03 DNAèƒå–+QC - çµ„ç¹” DNAèƒå–',
      'Q-ED04 DNAèƒå–+QC - çŸ³è ŸåŒ…åŸ‹ (FFPE) DNAèƒå–',
      'Q-ED05 DNAèƒå–+QC - è¡€æ¸…(æ¼¿) cfDNAèƒå–',
      'Q-ER01A RNAèƒå–+QC',
      'Q-ER01B RNAèƒå–+QC',
      'Q-ER02 RNAèƒå–+QC',
      'Q-ER03 RNAèƒå–+QC',
      'Q-ER04 RNAèƒå–+QC',
      'Q-ER05 RNAèƒå–+QC'
    ],
    'åˆ†ææœå‹™ (A1)': [
      'A101 Non (ä¸åˆ†æ)',
      'A102 Fastq',
      'A103 BCL',
      'A104 UMI'
    ],
    'åˆ†ææœå‹™ (A2)': [
      'A201 Non',
      'A202 DRAGEN-Germline-XP',
      'A203 DRAGEN-Somatic-XP',
      'A204 RNAseq-Basic',
      'A205 RNAseq-Advanced',
      'A206 TSO500-Tissue',
      'A207 TSO500-ctDNA',
      'A208 miRNA',
      'A209 ChIPseq',
      'A210 CellRanger',
      'A211 SpaceRanger',
      'A212 scRNAseq-Standard',
      'A213 CeleScope',
      'A214 PacBio-16S',
      'A215 PacBio-HumanWGS',
      'A216 Transcriptome-de-novo',
      'A217 ServiceHour',
      'A218 DRAGEN-Germline-Server',
      'A219 DRAGEN-Somatic-Server'
    ],
    'åˆ†ææœå‹™ (A3)': [
      'A301 Non',
      'A302 Geneyx-Report',
      'A303 Geneyx-Report&Annotation-Germline',
      'A304 Geneyx-Account',
      'A305 Annotation-Germline',
      'A306 Annotation-Germline&JointCalling',
      'A307 Annotation-Somatic',
      'A308 Annotation-Somatic-PCGR',
      'A309 Annotation-Somatic-PCGR-maftools',
      'A310 OGM-Geneyx-Report',
      'A311 OGM-Geneyx-Account',
      'A312 ICI-Report',
      'A313 ICI-Account',
      'A314 MagicBison',
      'A315 SangerReport',
      'A316 HLAtyping'
    ],
    'å€Ÿå‡ºè©¦åŠ‘ (R)': [
      'R-M001',
      'R-M002',
      'R-M003',
      'R-M004',
      'R-M005',
      'R-M006',
      'R-M007',
      'R-M008',
      'R-M009',
      'R-M010'
    ],
    'å¯¦é©—æœå‹™å¤–åŒ… (OS)': [
      'S-OS04 Sanger ',
      'S-OS01',
      'S-OS02',
      'S-OS03',
      'L-OS01',
      'L-OS02',
      'L-OS03',
      'L-OS04',
      'L-OS05'
    ],
    'å°åŸºå®‰WGSåŒ…å¥—1': ['AP01 Fastq'],
    'å°åŸºå®‰WGSåŒ…å¥—2': ['AP02 Fastq'],
    'å°åŸºå®‰WGSåŒ…å¥—3': ['AP03 Fastq'],
    'å°åŸºå®‰WESåŒ…å¥—1': ['AP04 Fastq'],
    'å°åŸºå®‰WESåŒ…å¥—2': ['AP05 Fastq'],
    'å°åŸºå®‰WESåŒ…å¥—3': ['AP06 Fastq'],
    'RNAseq-BasicåŒ…å¥—': ['AP07 Fastq'],
    'RNAseq-AdvancedåŒ…å¥—': ['AP08 Fastq']
  };

  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value
    }));
    
    if (name === 'organization') {
      const filtered = organizationOptions.filter(org =>
        org.toLowerCase().includes(value.toLowerCase())
      );
      setFilteredOrgs(filtered);
      setShowOrgSuggestions(value.length > 0 && filtered.length > 0);
    }
  };

  const selectOrganization = (org) => {
    setFormData(prev => ({ ...prev, organization: org }));
    setShowOrgSuggestions(false);
  };

  const handleServiceItemChange = (index, field, value) => {
    const newItems = [...formData.serviceItems];
    newItems[index][field] = value;
    if (field === 'category') {
      newItems[index].services = [{ service: '', quantity: '' }];
    }
    setFormData(prev => ({ ...prev, serviceItems: newItems }));
  };

  const handleServiceChange = (itemIndex, serviceIndex, field, value) => {
    const newItems = [...formData.serviceItems];
    newItems[itemIndex].services[serviceIndex][field] = value;
    setFormData(prev => ({ ...prev, serviceItems: newItems }));
  };

  const handleLibrarySampleSheetChange = (index, field, value) => {
    const newSampleSheet = [...formData.libraryInfo.sampleSheet];
    newSampleSheet[index][field] = value;
    setFormData(prev => ({
      ...prev,
      libraryInfo: {
        ...prev.libraryInfo,
        sampleSheet: newSampleSheet
      }
    }));
  };

  // è™•ç†è¡¨æ ¼è²¼ä¸Šäº‹ä»¶ - Sample Sheet
  const handleTablePaste = (e, startIndex) => {
    e.preventDefault();
    const pastedText = e.clipboardData.getData('text');
    const rows = pastedText.split('\n').filter(row => row.trim());
    
    const newSampleSheet = [...formData.libraryInfo.sampleSheet];
    
    rows.forEach((row, rowIndex) => {
      const columns = row.split('\t');
      const targetIndex = startIndex + rowIndex;
      
      // å¦‚æœéœ€è¦æ–°å¢è¡Œ
      while (targetIndex >= newSampleSheet.length) {
        newSampleSheet.push({
          no: newSampleSheet.length + 1,
          sampleName: '',
          tubeLabel: '',
          conc: '',
          vol: '',
          ngsConc: '',
          expectedSeq: '',
          note: ''
        });
      }
      
      // å¡«å……è³‡æ–™
      if (columns.length >= 1) {
        newSampleSheet[targetIndex] = {
          no: targetIndex + 1,
          sampleName: columns[0] || '',
          tubeLabel: columns[1] || '',
          conc: columns[2] || '',
          vol: columns[3] || '',
          ngsConc: columns[4] || '',
          expectedSeq: columns[5] || '',
          note: columns[6] || ''
        };
      }
    });
    
    setFormData(prev => ({
      ...prev,
      libraryInfo: {
        ...prev.libraryInfo,
        sampleSheet: newSampleSheet
      }
    }));
    
    setMessage(`å·²è²¼ä¸Š ${rows.length} è¡Œè³‡æ–™`);
    setTimeout(() => setMessage(''), 2000);
  };

  const addLibrarySampleSheetRow = () => {
    const newRow = {
      no: formData.libraryInfo.sampleSheet.length + 1,
      sampleName: '',
      tubeLabel: '',
      conc: '',
      vol: '',
      ngsConc: '',
      expectedSeq: '',
      note: ''
    };
    setFormData(prev => ({
      ...prev,
      libraryInfo: {
        ...prev.libraryInfo,
        sampleSheet: [...prev.libraryInfo.sampleSheet, newRow]
      }
    }));
  };

  const removeLibrarySampleSheetRow = (index) => {
    if (formData.libraryInfo.sampleSheet.length === 1) {
      alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡Œ');
      return;
    }
    const newSampleSheet = formData.libraryInfo.sampleSheet.filter((_, i) => i !== index);
    setFormData(prev => ({
      ...prev,
      libraryInfo: {
        ...prev.libraryInfo,
        sampleSheet: newSampleSheet
      }
    }));
  };

  const handleLibraryDetailChange = (index, field, value) => {
    const newLibrarySheet = [...formData.libraryInfo.librarySampleSheet];
    newLibrarySheet[index][field] = value;
    setFormData(prev => ({
      ...prev,
      libraryInfo: {
        ...prev.libraryInfo,
        librarySampleSheet: newLibrarySheet
      }
    }));
  };

  // è™•ç†è¡¨æ ¼è²¼ä¸Šäº‹ä»¶ - Library Detail
  const handleLibraryDetailTablePaste = (e, startIndex) => {
    e.preventDefault();
    const pastedText = e.clipboardData.getData('text');
    const rows = pastedText.split('\n').filter(row => row.trim());
    
    const newLibrarySheet = [...formData.libraryInfo.librarySampleSheet];
    
    rows.forEach((row, rowIndex) => {
      const columns = row.split('\t');
      const targetIndex = startIndex + rowIndex;
      
      // å¦‚æœéœ€è¦æ–°å¢è¡Œ
      while (targetIndex >= newLibrarySheet.length) {
        newLibrarySheet.push({
          no: newLibrarySheet.length + 1,
          sampleName: '',
          libraryPrepKit: '',
          indexAdapterKit: '',
          setWellPosition: '',
          index1Seq: '',
          index2Seq: '',
          note: '',
          library: ''
        });
      }
      
      // å¡«å……è³‡æ–™ï¼ŒåŒ…æ‹¬ library æ¬„ä½ï¼ˆå³ä½¿æ˜¯ä¸‹æ‹‰é¸å–®ä¹Ÿæ¥å—è²¼ä¸Šçš„å€¼ï¼‰
      if (columns.length >= 1) {
        newLibrarySheet[targetIndex] = {
          no: targetIndex + 1,
          sampleName: columns[0] || '',
          libraryPrepKit: columns[1] || '',
          indexAdapterKit: columns[2] || '',
          setWellPosition: columns[3] || '',
          index1Seq: columns[4] || '',
          index2Seq: columns[5] || '',
          note: columns[6] || '',
          library: columns[7] || ''  // æ¥å—è²¼ä¸Šçš„å€¼
        };
      }
    });
    
    setFormData(prev => ({
      ...prev,
      libraryInfo: {
        ...prev.libraryInfo,
        librarySampleSheet: newLibrarySheet
      }
    }));
    
    setMessage(`å·²è²¼ä¸Š ${rows.length} è¡Œè³‡æ–™`);
    setTimeout(() => setMessage(''), 2000);
  };

  const addLibraryDetailRow = () => {
    const newRow = {
      no: formData.libraryInfo.librarySampleSheet.length + 1,
      sampleName: '',
      libraryPrepKit: '',
      indexAdapterKit: '',
      setWellPosition: '',
      index1Seq: '',
      index2Seq: '',
      note: '',
      library: ''
    };
    setFormData(prev => ({
      ...prev,
      libraryInfo: {
        ...prev.libraryInfo,
        librarySampleSheet: [...prev.libraryInfo.librarySampleSheet, newRow]
      }
    }));
  };

  const removeLibraryDetailRow = (index) => {
    if (formData.libraryInfo.librarySampleSheet.length === 1) {
      alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡Œ');
      return;
    }
    const newLibrarySheet = formData.libraryInfo.librarySampleSheet.filter((_, i) => i !== index);
    setFormData(prev => ({
      ...prev,
      libraryInfo: {
        ...prev.libraryInfo,
        librarySampleSheet: newLibrarySheet
      }
    }));
  };

  // ä¸‹è¼‰ Library Sample Sheet ç¯„æœ¬
  const downloadTemplate = () => {
    const csvContent = "åºè™Ÿ,Sample_Name,Tube Label,Conc (ng/ul),Vol (uL),NGSä¸Šæ©Ÿæ¿ƒåº¦ (pM),é æœŸå®šåºé‡,å‚™è¨»\n1,,,,,,\n2,,,,,,\n3,,,,,,";
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Library_SampleSheet_Template.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    setMessage('ç¯„æœ¬å·²ä¸‹è¼‰');
    setTimeout(() => setMessage(''), 2000);
  };

  // ä¸‹è¼‰å®Œæ•´ Excel ç¯„æœ¬
  const downloadExcelTemplate = async () => {
    try {
      const XLSX = await import('xlsx');
      
      // å‰µå»º Sample Sheet
      const sampleSheetData = [
        ['åºè™Ÿ', 'Sample_Name', 'Tube Label', 'Conc (ng/ul)', 'Vol (uL)', 'NGSä¸Šæ©Ÿæ¿ƒåº¦ (pM)', 'é æœŸå®šåºé‡', 'å‚™è¨»'],
        [1, '', '', '', '', '', '', ''],
        [2, '', '', '', '', '', '', ''],
        [3, '', '', '', '', '', '', '']
      ];
      
      // å‰µå»º Library Sample Sheet
      const librarySheetData = [
        ['åºè™Ÿ', 'Sample_Name', 'Library Prep Kit', 'Index Adapter Kit', 'Set-Well Position', 'Index 1 (i7)', 'Index 2 (i5)', 'å‚™è¨»', 'Library'],
        [1, '', '', '', '', '', '', '', ''],
        [2, '', '', '', '', '', '', '', ''],
        [3, '', '', '', '', '', '', '', '']
      ];
      
      const wb = XLSX.utils.book_new();
      const ws1 = XLSX.utils.aoa_to_sheet(sampleSheetData);
      const ws2 = XLSX.utils.aoa_to_sheet(librarySheetData);
      
      XLSX.utils.book_append_sheet(wb, ws1, 'Sample Sheet');
      XLSX.utils.book_append_sheet(wb, ws2, 'Library Sample Sheet');
      
      XLSX.writeFile(wb, 'Library_Template.xlsx');
      setMessage('Excel ç¯„æœ¬å·²ä¸‹è¼‰');
      setTimeout(() => setMessage(''), 2000);
    } catch (error) {
      alert('ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
    }
  };

  // ä¸Šå‚³ Excel ä¸¦è‡ªå‹•å¸¶å…¥
  const handleExcelUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const XLSX = await import('xlsx');
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      
      // è®€å– Sample Sheet
      const sampleSheetName = workbook.SheetNames.find(name => name.includes('Sample'));
      if (sampleSheetName) {
        const worksheet = workbook.Sheets[sampleSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        const newSampleSheet = [];
        jsonData.forEach((row, index) => {
          if (index > 0 && row.length > 1) {
            newSampleSheet.push({
              no: index,
              sampleName: row[1] || '',
              tubeLabel: row[2] || '',
              conc: row[3] || '',
              vol: row[4] || '',
              ngsConc: row[5] || '',
              expectedSeq: row[6] || '',
              note: row[7] || ''
            });
          }
        });
        
        if (newSampleSheet.length > 0) {
          setFormData(prev => ({
            ...prev,
            libraryInfo: {
              ...prev.libraryInfo,
              sampleSheet: newSampleSheet
            }
          }));
        }
      }
      
      // è®€å– Library Sample Sheet
      const librarySheetName = workbook.SheetNames.find(name => name.includes('Library'));
      if (librarySheetName) {
        const worksheet = workbook.Sheets[librarySheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        const newLibrarySheet = [];
        jsonData.forEach((row, index) => {
          if (index > 0 && row.length > 1) {
            newLibrarySheet.push({
              no: index,
              sampleName: row[1] || '',
              libraryPrepKit: row[2] || '',
              indexAdapterKit: row[3] || '',
              setWellPosition: row[4] || '',
              index1Seq: row[5] || '',
              index2Seq: row[6] || '',
              note: row[7] || '',
              library: row[8] || ''
            });
          }
        });
        
        if (newLibrarySheet.length > 0) {
          setFormData(prev => ({
            ...prev,
            libraryInfo: {
              ...prev.libraryInfo,
              librarySampleSheet: newLibrarySheet
            }
          }));
        }
      }
      
      setMessage('Excel æª”æ¡ˆå·²åŒ¯å…¥');
      setTimeout(() => setMessage(''), 2000);
      e.target.value = '';
    } catch (error) {
      alert('ä¸Šå‚³å¤±æ•—ï¼š' + error.message);
    }
  };

  // æ¸…ç©º Sample Sheet
  const clearSampleSheet = () => {
    if (window.confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ Sample Sheet è³‡æ–™å—ï¼Ÿ')) {
      setFormData(prev => ({
        ...prev,
        libraryInfo: {
          ...prev.libraryInfo,
          sampleSheet: [{
            no: 1,
            sampleName: '',
            tubeLabel: '',
            conc: '',
            vol: '',
            ngsConc: '',
            expectedSeq: '',
            note: ''
          }]
        }
      }));
      setMessage('Sample Sheet å·²æ¸…ç©º');
      setTimeout(() => setMessage(''), 2000);
    }
  };

  // æ¸…ç©º Library Sample Sheet
  const clearLibrarySheet = () => {
    if (window.confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ Library Sample Sheet è³‡æ–™å—ï¼Ÿ')) {
      setFormData(prev => ({
        ...prev,
        libraryInfo: {
          ...prev.libraryInfo,
          librarySampleSheet: [{
            no: 1,
            sampleName: '',
            libraryPrepKit: '',
            indexAdapterKit: '',
            setWellPosition: '',
            index1Seq: '',
            index2Seq: '',
            note: '',
            library: ''
          }]
        }
      }));
      setMessage('Library Sample Sheet å·²æ¸…ç©º');
      setTimeout(() => setMessage(''), 2000);
    }
  };

  // ===== é Library æ¨£æœ¬è™•ç†å‡½æ•¸ =====
  
  const handleSampleSheetChange = (index, field, value) => {
    const newSampleSheet = [...formData.sampleInfo.sampleSheet];
    newSampleSheet[index][field] = value;
    setFormData(prev => ({
      ...prev,
      sampleInfo: {
        ...prev.sampleInfo,
        sampleSheet: newSampleSheet
      }
    }));
  };

  const handleSampleTablePaste = (e, startIndex) => {
    e.preventDefault();
    const pastedText = e.clipboardData.getData('text');
    const rows = pastedText.split('\n').filter(row => row.trim());
    
    const newSampleSheet = [...formData.sampleInfo.sampleSheet];
    
    rows.forEach((row, rowIndex) => {
      const columns = row.split('\t');
      const targetIndex = startIndex + rowIndex;
      
      while (targetIndex >= newSampleSheet.length) {
        newSampleSheet.push({
          no: newSampleSheet.length + 1,
          sampleName: '',
          tubeLabel: '',
          expectedSeq: '',
          conc: '',
          vol: '',
          ratio260280: '',
          ratio260230: '',
          dqnRqn: '',
          note: ''
        });
      }
      
      if (columns.length >= 1) {
        newSampleSheet[targetIndex] = {
          no: targetIndex + 1,
          sampleName: columns[0] || '',
          tubeLabel: columns[1] || '',
          expectedSeq: columns[2] || '',
          conc: columns[3] || '',
          vol: columns[4] || '',
          ratio260280: columns[5] || '',
          ratio260230 : columns[6] || '',
          dqnRqn: columns[7] || '',
          note: columns[8] || ''
        };
      }
    });
    
    setFormData(prev => ({
      ...prev,
      sampleInfo: {
        ...prev.sampleInfo,
        sampleSheet: newSampleSheet
      }
    }));
    
    setMessage(`å·²è²¼ä¸Š ${rows.length} è¡Œè³‡æ–™`);
    setTimeout(() => setMessage(''), 2000);
  };

  const addSampleSheetRow = () => {
    const newRow = {
      no: formData.sampleInfo.sampleSheet.length + 1,
      sampleName: '',
      tubeLabel: '',
      conc: '',
      vol: '',
      note: ''
    };
    setFormData(prev => ({
      ...prev,
      sampleInfo: {
        ...prev.sampleInfo,
        sampleSheet: [...prev.sampleInfo.sampleSheet, newRow]
      }
    }));
  };

  const removeSampleSheetRow = (index) => {
    if (formData.sampleInfo.sampleSheet.length === 1) {
      alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡Œ');
      return;
    }
    const newSampleSheet = formData.sampleInfo.sampleSheet.filter((_, i) => i !== index);
    setFormData(prev => ({
      ...prev,
      sampleInfo: {
        ...prev.sampleInfo,
        sampleSheet: newSampleSheet
      }
    }));
  };

  const clearSampleInfoSheet = () => {
    if (window.confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ¨£æœ¬è³‡æ–™å—ï¼Ÿ')) {
      setFormData(prev => ({
        ...prev,
        sampleInfo: {
          sampleSheet: [{
            no: 1,
            sampleName: '',
            tubeLabel: '',
            conc: '',
            vol: '',
            note: ''
          }]
        }
      }));
      setMessage('æ¨£æœ¬è³‡æ–™å·²æ¸…ç©º');
      setTimeout(() => setMessage(''), 2000);
    }
  };

  const downloadSampleTemplate = () => {
    const csvContent = "åºè™Ÿ,Sample_Name,Tube Label,Conc (ng/ul),Vol (uL),å‚™è¨»\n1,,,,,\n2,,,,,\n3,,,,,";
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Sample_Template.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    setMessage('ç¯„æœ¬å·²ä¸‹è¼‰');
    setTimeout(() => setMessage(''), 2000);
  };

  const downloadSampleExcelTemplate = async () => {
    try {
      const XLSX = await import('xlsx');
      
      const sampleSheetData = [
        ['åºè™Ÿ', 'Sample_Name', 'Tube Label', 'Conc (ng/ul)', 'Vol (uL)', 'å‚™è¨»'],
        [1, '', '', '', '', ''],
        [2, '', '', '', '', ''],
        [3, '', '', '', '', '']
      ];
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(sampleSheetData);
      
      XLSX.utils.book_append_sheet(wb, ws, 'Sample Sheet');
      XLSX.writeFile(wb, `${formData.sampleType}_Sample_Template.xlsx`);
      setMessage('Excel ç¯„æœ¬å·²ä¸‹è¼‰');
      setTimeout(() => setMessage(''), 2000);
    } catch (error) {
      alert('ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
    }
  };

  const handleSampleExcelUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const XLSX = await import('xlsx');
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      
      const sampleSheetName = workbook.SheetNames[0];
      if (sampleSheetName) {
        const worksheet = workbook.Sheets[sampleSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        const newSampleSheet = [];
        jsonData.forEach((row, index) => {
          if (index > 0 && row.length > 1) {
            newSampleSheet.push({
              no: index,
              sampleName: row[1] || '',
              tubeLabel: row[2] || '',
              conc: row[3] || '',
              vol: row[4] || '',
              note: row[5] || ''
            });
          }
        });
        
        if (newSampleSheet.length > 0) {
          setFormData(prev => ({
            ...prev,
            sampleInfo: {
              sampleSheet: newSampleSheet
            }
          }));
        }
      }
      
      setMessage('Excel æª”æ¡ˆå·²åŒ¯å…¥');
      setTimeout(() => setMessage(''), 2000);
      e.target.value = '';
    } catch (error) {
      alert('ä¸Šå‚³å¤±æ•—ï¼š' + error.message);
    }
  };

  // ä¸‹è¼‰ Library Detail ç¯„æœ¬
  const downloadLibraryDetailTemplate = () => {
    const csvContent = "åºè™Ÿ,Sample_Name,Library Prep Kit,Index Adapter Kit,Set-Well Position,Index 1 (i7),Index 2 (i5),å‚™è¨»,Library\n1,,,,,,,\n2,,,,,,,\n3,,,,,,,";
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Library_Detail_Template.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    setMessage('ç¯„æœ¬å·²ä¸‹è¼‰');
    setTimeout(() => setMessage(''), 2000);
  };

  // è™•ç† Library Detail è²¼ä¸Šè³‡æ–™
  const handlePasteLibraryDetail = () => {
    if (!pasteData.trim()) {
      alert('è«‹å…ˆè²¼ä¸Šè³‡æ–™');
      return;
    }

    try {
      const rows = pasteData.trim().split('\n');
      const newLibrarySheet = [];

      rows.forEach((row, index) => {
        const columns = row.split('\t');
        if (columns.length >= 8 && index > 0) {
          newLibrarySheet.push({
            no: index,
            sampleName: columns[1] || '',
            libraryPrepKit: columns[2] || '',
            indexAdapterKit: columns[3] || '',
            setWellPosition: columns[4] || '',
            index1Seq: columns[5] || '',
            index2Seq: columns[6] || '',
            note: columns[7] || '',
            library: columns[8] || ''
          });
        }
      });

      if (newLibrarySheet.length > 0) {
        setFormData(prev => ({
          ...prev,
          libraryInfo: {
            ...prev.libraryInfo,
            librarySampleSheet: newLibrarySheet
          }
        }));
        setShowPasteModal(false);
        setPasteData('');
        setMessage(`æˆåŠŸåŒ¯å…¥ ${newLibrarySheet.length} ç­†è³‡æ–™`);
        setTimeout(() => setMessage(''), 2000);
      } else {
        alert('ç„¡æ³•è§£æè³‡æ–™ï¼Œè«‹ç¢ºèªæ ¼å¼æ­£ç¢º');
      }
    } catch (error) {
      alert('è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼š' + error.message);
    }
  };

  // è™•ç† Excel è²¼ä¸Šè³‡æ–™
  const handlePasteData = () => {
    if (!pasteData.trim()) {
      alert('è«‹å…ˆè²¼ä¸Šè³‡æ–™');
      return;
    }

    if (pasteMode === 'sampleSheet') {
      handlePasteSampleSheet();
    } else {
      handlePasteLibraryDetail();
    }
  };

  const handlePasteSampleSheet = () => {
    try {
      const rows = pasteData.trim().split('\n');
      const newSampleSheet = [];

      rows.forEach((row, index) => {
        const columns = row.split('\t');
        if (columns.length >= 7 && index > 0) {
          newSampleSheet.push({
            no: index,
            sampleName: columns[1] || '',
            tubeLabel: columns[2] || '',
            conc: columns[3] || '',
            vol: columns[4] || '',
            ngsConc: columns[5] || '',
            expectedSeq: columns[6] || '',
            note: columns[7] || ''
          });
        }
      });

      if (newSampleSheet.length > 0) {
        setFormData(prev => ({
          ...prev,
          libraryInfo: {
            ...prev.libraryInfo,
            sampleSheet: newSampleSheet
          }
        }));
        setShowPasteModal(false);
        setPasteData('');
        setMessage(`æˆåŠŸåŒ¯å…¥ ${newSampleSheet.length} ç­†è³‡æ–™`);
        setTimeout(() => setMessage(''), 2000);
      } else {
        alert('ç„¡æ³•è§£æè³‡æ–™ï¼Œè«‹ç¢ºèªæ ¼å¼æ­£ç¢º');
      }
    } catch (error) {
      alert('è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼š' + error.message);
    }
  };

  // è™•ç†æª”æ¡ˆä¸Šå‚³
  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const Papa = await import('papaparse');
      
      Papa.parse(file, {
        complete: (results) => {
          const data = results.data;
          const newSampleSheet = [];

          data.forEach((row, index) => {
            if (index > 0 && row.length >= 7) { // è·³éæ¨™é¡Œè¡Œ
              newSampleSheet.push({
                no: index,
                sampleName: row[1] || '',
                tubeLabel: row[2] || '',
                conc: row[3] || '',
                vol: row[4] || '',
                ngsConc: row[5] || '',
                expectedSeq: row[6] || '',
                note: row[7] || ''
              });
            }
          });

          if (newSampleSheet.length > 0) {
            setFormData(prev => ({
              ...prev,
              libraryInfo: {
                ...prev.libraryInfo,
                sampleSheet: newSampleSheet
              }
            }));
            setMessage(`æˆåŠŸåŒ¯å…¥ ${newSampleSheet.length} ç­†è³‡æ–™`);
            setTimeout(() => setMessage(''), 2000);
          }
        },
        error: (error) => {
          alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
        }
      });
    } catch (error) {
      alert('ä¸Šå‚³å¤±æ•—ï¼š' + error.message);
    }
  };

  const addService = (itemIndex) => {
    const newItems = [...formData.serviceItems];
    newItems[itemIndex].services.push({ service: '', quantity: '' });
    setFormData(prev => ({ ...prev, serviceItems: newItems }));
  };

  const removeService = (itemIndex, serviceIndex) => {
    const newItems = [...formData.serviceItems];
    if (newItems[itemIndex].services.length === 1) {
      alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€é …æœå‹™å“é …');
      return;
    }
    newItems[itemIndex].services = newItems[itemIndex].services.filter((_, i) => i !== serviceIndex);
    setFormData(prev => ({ ...prev, serviceItems: newItems }));
  };

  const addServiceItem = () => {
    setFormData(prev => ({
      ...prev,
      serviceItems: [...prev.serviceItems, {
        category: 'è«‹é¸æ“‡æœå‹™é¡åˆ¥',
        services: [{ service: '', quantity: '' }],
        libraryType: 'ç„¡',
        seqSpec: ''
      }]
    }));
  };

  const removeServiceItem = (index) => {
    if (formData.serviceItems.length === 1) {
      alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€çµ„æœå‹™é¡åˆ¥');
      return;
    }
    const newItems = formData.serviceItems.filter((_, i) => i !== index);
    setFormData(prev => ({ ...prev, serviceItems: newItems }));
  };

  const handleSignatureSave = (signatureData) => {
    setFormData(prev => ({ ...prev, signature: signatureData }));
    setShowSignaturePad(false);
    setMessage('ç°½åå·²ä¿å­˜');
    setTimeout(() => setMessage(''), 2000);
  };

  const handleSignatureCancel = () => {
    setShowSignaturePad(false);
  };

  const clearSignature = () => {
    setFormData(prev => ({ ...prev, signature: null }));
    setMessage('ç°½åå·²æ¸…é™¤');
    setTimeout(() => setMessage(''), 2000);
  };

  const handleSubmit = async () => {
    if (!formData.organization || !formData.contactPerson || !formData.email) {
      setMessage('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆæ¨™ * è€…ï¼‰');
      return;
    }
    
    if (!formData.signature) {
      setMessage('è«‹å…ˆç°½åç¢ºèªè¨‚å–®å…§å®¹');
      return;
    }
    
    try {
      const response = await fetch('http://192.168.60.62:3001/api/orders', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        setSubmitted(true);
        setOrderId(result.orderId);
        setMessage(`è¨‚å–®å·²æˆåŠŸæäº¤ï¼è¨‚å–®ç·¨è™Ÿï¼š${result.orderId}`);
        setTimeout(() => {
          setSubmitted(false);
        }, 5000);
      } else {
        setMessage('æäº¤å¤±æ•—ï¼š' + result.error);
      }
    } catch (error) {
      setMessage('æäº¤å¤±æ•—ï¼š' + error.message);
    }
  };

  const exportToExcel = async () => {
    if (!orderId) {
      setMessage('è«‹å…ˆæäº¤è¨‚å–®æ‰èƒ½åŒ¯å‡º Excel');
      return;
    }
    
    try {
      const response = await fetch(`http://192.168.60.62:3001/api/orders/${orderId}/export`);
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `TGIA_Order_${orderId}.xlsx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      setMessage('Excel æª”æ¡ˆä¸‹è¼‰æˆåŠŸ');
      setTimeout(() => setMessage(''), 2000);
    } catch (error) {
      setMessage('åŒ¯å‡ºå¤±æ•—ï¼š' + error.message);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 py-8 px-4">
      <div className="max-w-5xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <div className="text-center mb-8 border-b pb-6">
          <h1 className="text-3xl font-bold text-gray-800 mb-2">
            å°åŸºç›Ÿç”ŸæŠ€è‚¡ä»½æœ‰é™å…¬å¸
          </h1>
          <h2 className="text-xl text-gray-600 mb-4">
            å§”è¨—æœå‹™åŒæ„æ›¸/è¨‚è³¼ç¢ºèªå–®
          </h2>
          <div className="flex justify-between text-sm text-gray-500">
            <span>æ­£å¸¸å–®</span>
            <span className="text-red-600">æ¨™ * ç‚ºå¿…å¡«ä¹‹æ¬„ä½</span>
          </div>
        </div>

        <div className="space-y-8">
          {/* åŸºæœ¬è³‡è¨Š */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                æ¥­å‹™äººå“¡ <span className="text-red-600">*</span>
              </label>
              <select
                name="salesPerson"
                value={formData.salesPerson}
                onChange={handleInputChange}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                {salesPersonOptions.map((person, index) => (
                  <option key={index} value={person}>{person}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                å¡«å¯«æ—¥æœŸ
              </label>
              <input
                type="date"
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                defaultValue={new Date().toISOString().split('T')[0]}
              />
            </div>
          </div>

          {/* åŸºæœ¬è³‡è¨Š - å¤§æ¡† */}
          <div className="border-2 border-gray-400 rounded-lg p-6 bg-white shadow-md">
            <h2 className="text-xl font-bold text-gray-800 mb-6 pb-3 border-b-2 border-gray-300">
              åŸºæœ¬è³‡è¨Š
            </h2>

            {/* 1. å§”è¨—äººè³‡è¨Š */}
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-gray-700 mb-4 pb-2 border-b border-gray-200">
                1. å§”è¨—äººè³‡è¨Š
              </h3>
              <div className="grid grid-cols-2 gap-4">
                <div className="relative">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    å–®ä½ <span className="text-red-600">*</span>
                  </label>
                  <input
                    type="text"
                    name="organization"
                    value={formData.organization}
                    onChange={handleInputChange}
                    onFocus={() => {
                      if (formData.organization) {
                        const filtered = organizationOptions.filter(org =>
                          org.toLowerCase().includes(formData.organization.toLowerCase())
                        );
                        setFilteredOrgs(filtered);
                        setShowOrgSuggestions(filtered.length > 0);
                      }
                    }}
                    onBlur={() => setTimeout(() => setShowOrgSuggestions(false), 200)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    placeholder="ä¾‹ï¼šåœ‹ç«‹é™½æ˜äº¤é€šå¤§å­¸"
                  />
                  {showOrgSuggestions && (
                    <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto">
                      {filteredOrgs.map((org, index) => (
                        <div
                          key={index}
                          onClick={() => selectOrganization(org)}
                          className="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm"
                        >
                          {org}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    è² è²¬äºº/ä¸»æŒäºº <span className="text-red-600">*</span>
                  </label>
                  <input
                    type="text"
                    name="principalInvestigator"
                    value={formData.principalInvestigator}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    è¯çµ¡äºº <span className="text-red-600">*</span>
                  </label>
                  <input
                    type="text"
                    name="contactPerson"
                    value={formData.contactPerson}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    è¯çµ¡é›»è©± <span className="text-red-600">*</span>
                  </label>
                  <input
                    type="tel"
                    name="contactPhone"
                    value={formData.contactPhone}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    placeholder="886-2-2826-7319"
                  />
                </div>
                <div className="col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Email <span className="text-red-600">*</span>
                  </label>
                  <input
                    type="email"
                    name="email"
                    value={formData.email}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    placeholder="example@nycu.edu.tw"
                  />
                </div>
                <div className="col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    åœ°å€
                  </label>
                  <input
                    type="text"
                    name="address"
                    value={formData.address}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>
            </div>

            {/* ç™¼ç¥¨è³‡è¨Š */}
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-gray-700 mb-4 pb-2 border-b border-gray-200">
                ç™¼ç¥¨è³‡è¨Š
              </h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    æŠ¬é ­
                  </label>
                  <input
                    type="text"
                    name="invoiceTitle"
                    value={formData.invoiceTitle}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    çµ±ç·¨
                  </label>
                  <input
                    type="text"
                    name="taxId"
                    value={formData.taxId}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    maxLength={8}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    ç™¼ç¥¨è¯æ•¸
                  </label>
                  <select
                    name="invoiceCopies"
                    value={formData.invoiceCopies}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                  >
                    <option>äºŒè¯å¼</option>
                    <option>ä¸‰è¯å¼</option>
                  </select>
                </div>
              </div>
            </div>

            {/* æ•¸æ“šäº¤ä»˜è³‡è¨Š */}
            <div>
              <h3 className="text-lg font-semibold text-gray-700 mb-4 pb-2 border-b border-gray-200">
                æ•¸æ“šäº¤ä»˜è³‡è¨Š
              </h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    æ•¸æ“šæä¾›æ–¹å¼ <span className="text-red-600">*</span>
                  </label>
                  <select
                    name="dataDeliveryMethod"
                    value={formData.dataDeliveryMethod}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                  >
                    <option>HDDç”±å°ˆäººéé€</option>
                    <option>åœ‹ç¶²ä¸­å¿ƒä¸‹è¼‰</option>
                    <option>é›²ç«¯ä¸‹è¼‰</option>
                    <option>sFTPä¸‹è¼‰</option>
                  </select>
                </div>
                
                {formData.dataDeliveryMethod === 'åœ‹ç¶²ä¸­å¿ƒä¸‹è¼‰' && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      æ•¸æ“šä¸‹è¼‰åœ‹ç¶²å¸³è™Ÿ
                    </label>
                    <input
                      type="text"
                      name="nchcAccount"
                      value={formData.nchcAccount}
                      onChange={handleInputChange}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                      placeholder="è«‹è¼¸å…¥åœ‹ç¶²ä¸­å¿ƒå¸³è™Ÿ"
                    />
                  </div>
                )}
                
                {formData.dataDeliveryMethod === 'HDDç”±å°ˆäººéé€' && (
                  <>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        æ•¸æ“šç¡¬ç¢Ÿäº¤è²¨åœ°å€
                      </label>
                      <input
                        type="text"
                        name="deliveryAddress"
                        value={formData.deliveryAddress}
                        onChange={handleInputChange}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                        placeholder="è«‹å¡«å¯«éƒµéå€è™Ÿ"
                      />
                    </div>
                    <div className="grid grid-cols-3 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          æ”¶ä»¶äºº
                        </label>
                        <input
                          type="text"
                          name="recipient"
                          value={formData.recipient}
                          onChange={handleInputChange}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          é›»è©±
                        </label>
                        <input
                          type="tel"
                          name="recipientPhone"
                          value={formData.recipientPhone}
                          onChange={handleInputChange}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Email
                        </label>
                        <input
                          type="email"
                          name="recipientEmail"
                          value={formData.recipientEmail}
                          onChange={handleInputChange}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>

          {/* 2. å§”è¨—å…§å®¹ */}
          <div className="border-2 border-gray-400 rounded-lg p-6 bg-white shadow-md">
            <h3 className="text-xl font-bold text-gray-800 mb-6 pb-3 border-b-2 border-gray-300">
              2. å§”è¨—å…§å®¹
            </h3>
            {formData.serviceItems.map((item, index) => (
              <div key={index} className="mb-6 p-4 bg-gray-50 rounded-lg border-2 border-gray-200 relative">
                {formData.serviceItems.length > 1 && (
                  <button
                    type="button"
                    onClick={() => removeServiceItem(index)}
                    className="absolute top-2 right-2 p-2 text-red-500 hover:bg-red-50 rounded-lg transition z-10 border border-red-300"
                    title="ç§»é™¤æ­¤æœå‹™é¡åˆ¥çµ„"
                  >
                    <X size={20} />
                  </button>
                )}
                
                <div className="mb-2 text-sm font-semibold text-gray-600">
                  æœå‹™é¡åˆ¥çµ„ #{index + 1}
                </div>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      æœå‹™é¡åˆ¥ <span className="text-red-600">*</span>
                    </label>
                    <select
                      value={item.category}
                      onChange={(e) => handleServiceItemChange(index, 'category', e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    >
                      {serviceCategories.map((cat, i) => (
                        <option key={i} value={cat}>{cat}</option>
                      ))}
                    </select>
                  </div>
                  
                  {item.category && item.category !== 'è«‹é¸æ“‡æœå‹™é¡åˆ¥' && (
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <label className="block text-sm font-medium text-gray-700">
                          æœå‹™å“é …èˆ‡æ•¸é‡ <span className="text-red-600">*</span>
                        </label>
                        <button
                          type="button"
                          onClick={() => addService(index)}
                          className="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1 px-3 py-1 rounded hover:bg-blue-50"
                        >
                          <Plus size={16} />
                          æ–°å¢å“é …
                        </button>
                      </div>
                      
                      {item.services.map((serviceItem, serviceIndex) => (
                        <div key={serviceIndex} className="flex gap-2 items-start bg-white p-3 rounded border border-gray-200">
                          <div className="flex-1">
                            <select
                              value={serviceItem.service}
                              onChange={(e) => handleServiceChange(index, serviceIndex, 'service', e.target.value)}
                              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                            >
                              <option value="">è«‹é¸æ“‡æœå‹™å“é …</option>
                              {serviceOptionsByCategory[item.category]?.map((opt, i) => (
                                <option key={i} value={opt}>{opt}</option>
                              ))}
                            </select>
                          </div>
                          <div className="w-32">
                            <input
                              type="number"
                              value={serviceItem.quantity}
                              onChange={(e) => handleServiceChange(index, serviceIndex, 'quantity', e.target.value)}
                              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                              placeholder="æ•¸é‡"
                              min="1"
                            />
                          </div>
                          {item.services.length > 1 && (
                            <button
                              type="button"
                              onClick={() => removeService(index, serviceIndex)}
                              className="p-2 text-red-500 hover:bg-red-50 rounded transition"
                              title="ç§»é™¤æ­¤å“é …"
                            >
                              <X size={18} />
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        å»ºåº«ç¨®é¡
                      </label>
                      <input
                        type="text"
                        value={item.libraryType}
                        onChange={(e) => handleServiceItemChange(index, 'libraryType', e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        å®šåºè¦æ ¼
                      </label>
                      <input
                        type="text"
                        value={item.seqSpec}
                        onChange={(e) => handleServiceItemChange(index, 'seqSpec', e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                        placeholder="ä¾‹ï¼šPE150; 1T+/-10%; Q30>= 80Â±5%"
                      />
                    </div>
                  </div>
                </div>
              </div>
            ))}
            <button
              type="button"
              onClick={addServiceItem}
              className="flex items-center gap-2 text-blue-600 hover:text-blue-800 text-sm font-medium px-4 py-2 rounded hover:bg-blue-50"
            >
              <Plus size={16} />
              æ–°å¢æœå‹™é¡åˆ¥çµ„
            </button>
          </div>

          {/* é€æ¸¬æ¨£å“è³‡è¨Š */}
          <div className="border-2 border-gray-400 rounded-lg p-6 bg-white shadow-md">
            <h3 className="text-xl font-bold text-gray-800 mb-6 pb-3 border-b-2 border-gray-300">
              é€æ¸¬æ¨£å“è³‡è¨Š
            </h3>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  æ¨£å“é¡å‹ <span className="text-red-600">*</span>
                </label>
                <select
                  name="sampleType"
                  value={formData.sampleType}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                >
                  <option>ç„¡é€æ¨£</option>  
                  <option>Library</option>
                  <option>DNA</option>
                  <option>RNA</option>
                  <option>Cell</option>
                  <option>Blood</option>
                  <option>å…¶ä»–</option>
                </select>
                {formData.sampleType === 'å…¶ä»–' && (
                  <input
                    type="text"
                    name="sampleTypeOther"
                    value={formData.sampleTypeOther}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 mt-2"
                    placeholder="è«‹èªªæ˜æ¨£å“é¡å‹"
                  />
                )}
              </div>
              
              {/* Library å°ˆå±¬æ¬„ä½ */}
              {formData.sampleType === 'Library' && (
                <div className="col-span-2 mt-4 border-2 border-blue-300 rounded-lg p-6 bg-blue-50">
                  <div className="flex items-center justify-between mb-4">
                    <h4 className="text-lg font-bold text-gray-800">Library é€ä»¶è³‡è¨Š</h4>
                    <div className="flex gap-2">
                      <input
                        ref={excelUploadRef}
                        type="file"
                        accept=".xlsx,.xls"
                        onChange={handleExcelUpload}
                        className="hidden"
                      />
                      <button
                        type="button"
                        onClick={downloadExcelTemplate}
                        className="text-xs text-green-600 hover:text-green-800 flex items-center gap-1 px-3 py-2 rounded hover:bg-green-50 border border-green-300"
                      >
                        <Download size={14} />
                        ä¸‹è¼‰ Excel ç¯„æœ¬
                      </button>
                      <button
                        type="button"
                        onClick={() => excelUploadRef.current?.click()}
                        className="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-3 py-2 rounded hover:bg-blue-50 border border-blue-300"
                      >
                        <Upload size={14} />
                        ä¸Šå‚³ Excel
                      </button>
                    </div>
                  </div>
                  <div className="mb-4 text-xs text-gray-600 bg-blue-50 p-2 rounded border border-blue-200">
                    ğŸ“Œ ä½¿ç”¨èªªæ˜ï¼š
                    <br/>â€¢ é»æ“Šã€Œä¸‹è¼‰ Excel ç¯„æœ¬ã€å–å¾—åŒ…å«å…©å€‹å·¥ä½œè¡¨çš„ç¯„æœ¬æª”æ¡ˆ
                    <br/>â€¢ åœ¨ç¯„æœ¬ä¸­å¡«å¯« Sample Sheet å’Œ Library Sample Sheet è³‡æ–™
                    <br/>â€¢ é»æ“Šã€Œä¸Šå‚³ Excelã€è‡ªå‹•åŒ¯å…¥å…©å€‹è¡¨æ ¼çš„è³‡æ–™
                    <br/>â€¢ ä¹Ÿå¯ä»¥ä½¿ç”¨å„è¡¨æ ¼ä¸Šçš„ã€Œè²¼ä¸Šè³‡æ–™ã€åŠŸèƒ½å–®ç¨åŒ¯å…¥
                  </div>
                  
                  {/* 2. Sample Sheet */}
                  <div className="mb-6">
                    <div className="flex items-center justify-between mb-3">
                      <h5 className="font-semibold text-gray-700">2. Sample Sheet</h5>
                      <div className="flex gap-2">
                        <button
                          type="button"
                          onClick={downloadTemplate}
                          className="text-xs text-green-600 hover:text-green-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-green-50 border border-green-300"
                        >
                          <Download size={14} />
                          ä¸‹è¼‰ç¯„æœ¬
                        </button>
                        <button
                          type="button"
                          onClick={() => {
                            setPasteMode('sampleSheet');
                            setShowPasteModal(true);
                          }}
                          className="text-xs text-purple-600 hover:text-purple-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-purple-50 border border-purple-300"
                        >
                          ğŸ“‹ è²¼ä¸Šè³‡æ–™
                        </button>
                        <button
                          type="button"
                          onClick={clearSampleSheet}
                          className="text-xs text-red-600 hover:text-red-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-red-50 border border-red-300"
                        >
                          <RotateCcw size={14} />
                          æ¸…ç©º
                        </button>
                        <button
                          type="button"
                          onClick={addLibrarySampleSheetRow}
                          className="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-blue-100 border border-blue-300"
                        >
                          <Plus size={14} />
                          æ–°å¢æ¨£æœ¬
                        </button>
                      </div>
                    </div>
                    <div className="mb-2 text-xs text-gray-500 bg-yellow-50 p-2 rounded border border-yellow-200">
                      ğŸ’¡ æç¤ºï¼š
                      <br/>â€¢ è¤‡è£½ Excel è³‡æ–™å‰ï¼Œè«‹å…ˆç¢ºèªæ²’æœ‰åˆä½µçš„å„²å­˜æ ¼
                      <br/>â€¢ å¾ Sample_Name æ¬„ä½é–‹å§‹è¤‡è£½ï¼ˆä¸å«åºè™Ÿå’Œæ¨™é¡Œï¼‰
                      <br/>â€¢ Library æ¬„ä½å¯è¼¸å…¥æˆ–å¾ä¸‹æ‹‰é¸å–®é¸æ“‡ï¼ˆå»ºè­°ä¾†è‡ª Sample Sheet çš„ Sample Nameï¼‰
                      <br/>â€¢ è¤‡è£½è²¼ä¸Šæ™‚ Library æ¬„ä½ä¹Ÿæœƒè‡ªå‹•å¡«å…¥
                      <br/>â€¢ é»æ“Šè¡¨æ ¼ä»»ä¸€å„²å­˜æ ¼å¾ŒæŒ‰ Ctrl+V è²¼ä¸Šï¼Œç³»çµ±æœƒè‡ªå‹•æ–°å¢è¡Œæ•¸
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm border-collapse">
                        <thead>
                          <tr className="bg-gray-100">
                            <th className="border p-2">åºè™Ÿ</th>
                            <th className="border p-2">Sample_Name*</th>
                            <th className="border p-2">Tube Label*</th>
                            <th className="border p-2">Conc* (ng/ul)</th>
                            <th className="border p-2">Vol* (uL)</th>
                            <th className="border p-2">NGSä¸Šæ©Ÿæ¿ƒåº¦ (pM)</th>
                            <th className="border p-2">é æœŸå®šåºé‡</th>
                            <th className="border p-2">å‚™è¨»</th>
                            <th className="border p-2">æ“ä½œ</th>
                          </tr>
                        </thead>
                        <tbody onPaste={(e) => handleTablePaste(e, 0)}>
                          {formData.libraryInfo.sampleSheet.map((row, idx) => (
                            <tr key={idx} className="bg-white">
                              <td className="border p-2 text-center">{idx + 1}</td>
                              <td className="border p-2">
                                <input
                                  type="text"
                                  value={row.sampleName}
                                  onChange={(e) => handleLibrarySampleSheetChange(idx, 'sampleName', e.target.value)}
                                  className="w-full px-2 py-1 border rounded"
                                />
                              </td>
                              <td className="border p-2">
                                <input
                                  type="text"
                                  value={row.tubeLabel}
                                  onChange={(e) => handleLibrarySampleSheetChange(idx, 'tubeLabel', e.target.value)}
                                  className="w-full px-2 py-1 border rounded"
                                />
                              </td>
                              <td className="border p-2">
                                <input
                                  type="number"
                                  value={row.conc}
                                  onChange={(e) => handleLibrarySampleSheetChange(idx, 'conc', e.target.value)}
                                  className="w-full px-2 py-1 border rounded"
                                />
                              </td>
                              <td className="border p-2">
                                <input
                                  type="number"
                                  value={row.vol}
                                  onChange={(e) => handleLibrarySampleSheetChange(idx, 'vol', e.target.value)}
                                  className="w-full px-2 py-1 border rounded"
                                />
                              </td>
                              <td className="border p-2">
                                <input
                                  type="number"
                                  value={row.ngsConc}
                                  onChange={(e) => handleLibrarySampleSheetChange(idx, 'ngsConc', e.target.value)}
                                  className="w-full px-2 py-1 border rounded"
                                />
                              </td>
                              <td className="border p-2">
                                <input
                                  type="number"
                                  value={row.expectedSeq}
                                  onChange={(e) => handleLibrarySampleSheetChange(idx, 'expectedSeq', e.target.value)}
                                  className="w-full px-2 py-1 border rounded"
                                />
                              </td>
                              <td className="border p-2">
                                <input
                                  type="text"
                                  value={row.note}
                                  onChange={(e) => handleLibrarySampleSheetChange(idx, 'note', e.target.value)}
                                  className="w-full px-2 py-1 border rounded"
                                />
                              </td>
                              <td className="border p-2 text-center">
                                {formData.libraryInfo.sampleSheet.length > 1 && (
                                  <button
                                    type="button"
                                    onClick={() => removeLibrarySampleSheetRow(idx)}
                                    className="text-red-500 hover:text-red-700"
                                  >
                                    <X size={16} />
                                  </button>
                                )}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                   
                    </div>
                  </div>

                  {/* 3. Run Configuration */}
                  <div className="mb-6">
                    <h5 className="font-semibold text-gray-700 mb-3">3. Run Configuration</h5>
                    <div className="grid grid-cols-2 gap-4 bg-white p-4 rounded">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">å®šåºæ©Ÿå‹</label>
                        <input
                          type="text"
                          value={formData.libraryInfo.runConfig.sequencer}
                          onChange={(e) => setFormData(prev => ({
                            ...prev,
                            libraryInfo: {
                              ...prev.libraryInfo,
                              runConfig: { ...prev.libraryInfo.runConfig, sequencer: e.target.value }
                            }
                          }))}
                          className="w-full px-3 py-2 border rounded"
                          placeholder="ä¸é™"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Read 1 Length (bp)*</label>
                        <input
                          type="text"
                          value={formData.libraryInfo.runConfig.read1Length}
                          onChange={(e) => setFormData(prev => ({
                            ...prev,
                            libraryInfo: {
                              ...prev.libraryInfo,
                              runConfig: { ...prev.libraryInfo.runConfig, read1Length: e.target.value }
                            }
                          }))}
                          className="w-full px-3 py-2 border rounded"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Read 2 Length (bp)*</label>
                        <input
                          type="text"
                          value={formData.libraryInfo.runConfig.read2Length}
                          onChange={(e) => setFormData(prev => ({
                            ...prev,
                            libraryInfo: {
                              ...prev.libraryInfo,
                              runConfig: { ...prev.libraryInfo.runConfig, read2Length: e.target.value }
                            }
                          }))}
                          className="w-full px-3 py-2 border rounded"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">phiX (%)</label>
                        <input
                          type="text"
                          value={formData.libraryInfo.runConfig.phiX}
                          onChange={(e) => setFormData(prev => ({
                            ...prev,
                            libraryInfo: {
                              ...prev.libraryInfo,
                              runConfig: { ...prev.libraryInfo.runConfig, phiX: e.target.value }
                            }
                          }))}
                          className="w-full px-3 py-2 border rounded"
                          placeholder="1%"
                        />
                      </div>
                    </div>
                  </div>

                  {/* 5. Library Sample Sheet */}
                  <div className="mb-6">
                    <div className="flex items-center justify-between mb-3">
                      <h5 className="font-semibold text-gray-700">5. Library Sample Sheet</h5>
                      <div className="flex gap-2">
                        <button
                          type="button"
                          onClick={downloadLibraryDetailTemplate}
                          className="text-xs text-green-600 hover:text-green-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-green-50 border border-green-300"
                        >
                          <Download size={14} />
                          ä¸‹è¼‰ç¯„æœ¬
                        </button>
                        <button
                          type="button"
                          onClick={() => {
                            setPasteMode('libraryDetail');
                            setShowPasteModal(true);
                          }}
                          className="text-xs text-purple-600 hover:text-purple-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-purple-50 border border-purple-300"
                        >
                          ğŸ“‹ è²¼ä¸Šè³‡æ–™
                        </button>
                        <button
                          type="button"
                          onClick={clearLibrarySheet}
                          className="text-xs text-red-600 hover:text-red-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-red-50 border border-red-300"
                        >
                          <RotateCcw size={14} />
                          æ¸…ç©º
                        </button>
                        <button
                          type="button"
                          onClick={addLibraryDetailRow}
                          className="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-blue-100 border border-blue-300"
                        >
                          <Plus size={14} />
                          æ–°å¢Library
                        </button>
                      </div>
                    </div>
                    <div className="mb-2 text-xs text-gray-500 bg-yellow-50 p-2 rounded border border-yellow-200">
                      ğŸ’¡ æç¤ºï¼š
                      <br/>â€¢ è¤‡è£½ Excel è³‡æ–™å‰ï¼Œè«‹å…ˆç¢ºèªæ²’æœ‰åˆä½µçš„å„²å­˜æ ¼
                      <br/>â€¢ å¾ Sample_Name æ¬„ä½é–‹å§‹è¤‡è£½ï¼ˆä¸å«åºè™Ÿå’Œæ¨™é¡Œï¼‰
                      <br/>â€¢ é»æ“Šè¡¨æ ¼ä»»ä¸€å„²å­˜æ ¼å¾ŒæŒ‰ Ctrl+V è²¼ä¸Šï¼Œç³»çµ±æœƒè‡ªå‹•æ–°å¢è¡Œæ•¸
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-xs border-collapse">
                        <thead>
                          <tr className="bg-gray-100">
                            <th className="border p-2">åºè™Ÿ</th>
                            <th className="border p-2">Sample_Name*</th>
                            <th className="border p-2">Library Prep Kit*</th>
                            <th className="border p-2">Index Adapter Kit</th>
                            <th className="border p-2">Set-Well Position</th>
                            <th className="border p-2">Index 1 (i7)*</th>
                            <th className="border p-2">Index 2 (i5)*</th>
                            <th className="border p-2">å‚™è¨»</th>
                            <th className="border p-2">Library</th>
                            <th className="border p-2">æ“ä½œ</th>
                          </tr>
                        </thead>
                        <tbody onPaste={(e) => handleLibraryDetailTablePaste(e, 0)}>
                          {formData.libraryInfo.librarySampleSheet.map((row, idx) => (
                            <tr key={idx} className="bg-white">
                              <td className="border p-2 text-center">{idx + 1}</td>
                              <td className="border p-2">
                                <input
                                  type="text"
                                  value={row.sampleName}
                                  onChange={(e) => handleLibraryDetailChange(idx, 'sampleName', e.target.value)}
                                  className="w-full px-2 py-1 border rounded text-xs"
                                />
                              </td>
                              <td className="border p-2">
                                <input
                                  type="text"
                                  value={row.libraryPrepKit}
                                  onChange={(e) => handleLibraryDetailChange(idx, 'libraryPrepKit', e.target.value)}
                                  className="w-full px-2 py-1 border rounded text-xs"
                                />
                              </td>
                              <td className="border p-2">
                                <input
                                  type="text"
                                  value={row.indexAdapterKit}
                                  onChange={(e) => handleLibraryDetailChange(idx, 'indexAdapterKit', e.target.value)}
                                  className="w-full px-2 py-1 border rounded text-xs"
                                />
                              </td>
                              <td className="border p-2">
                                <input
                                  type="text"
                                  value={row.setWellPosition}
                                  onChange={(e) => handleLibraryDetailChange(idx, 'setWellPosition', e.target.value)}
                                  className="w-full px-2 py-1 border rounded text-xs"
                                />
                              </td>
                              <td className="border p-2">
                                <input
                                  type="text"
                                  value={row.index1Seq}
                                  onChange={(e) => handleLibraryDetailChange(idx, 'index1Seq', e.target.value)}
                                  className="w-full px-2 py-1 border rounded text-xs"
                                />
                              </td>
                              <td className="border p-2">
                                <input
                                  type="text"
                                  value={row.index2Seq}
                                  onChange={(e) => handleLibraryDetailChange(idx, 'index2Seq', e.target.value)}
                                  className="w-full px-2 py-1 border rounded text-xs"
                                />
                              </td>
                              <td className="border p-2">
                                <input
                                  type="text"
                                  value={row.note}
                                  onChange={(e) => handleLibraryDetailChange(idx, 'note', e.target.value)}
                                  className="w-full px-2 py-1 border rounded text-xs"
                                />
                              </td>
                              <td className="border p-2">
                                <input
                                  type="text"
                                  list={`library-options-${idx}`}
                                  value={row.library}
                                  onChange={(e) => handleLibraryDetailChange(idx, 'library', e.target.value)}
                                  className="w-full px-2 py-1 border rounded text-xs"
                                  placeholder="è¼¸å…¥æˆ–é¸æ“‡"
                                />
                                <datalist id={`library-options-${idx}`}>
                                  {formData.libraryInfo.sampleSheet.map((sample, sIdx) => (
                                    sample.sampleName && (
                                      <option key={sIdx} value={sample.sampleName} />
                                    )
                                  ))}
                                </datalist>
                              </td>
                              <td className="border p-2 text-center">
                                {formData.libraryInfo.librarySampleSheet.length > 1 && (
                                  <button
                                    type="button"
                                    onClick={() => removeLibraryDetailRow(idx)}
                                    className="text-red-500 hover:text-red-700"
                                  >
                                    <X size={16} />
                                  </button>
                                )}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  {/* 6. é›»æ³³è† åœ– */}
                  <div>
                    <h5 className="font-semibold text-gray-700 mb-3">6. é›»æ³³è† åœ–</h5>
                    <textarea
                      value={formData.libraryInfo.gelImage}
                      onChange={(e) => setFormData(prev => ({
                        ...prev,
                        libraryInfo: { ...prev.libraryInfo, gelImage: e.target.value }
                      }))}
                      rows={3}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 bg-white"
                      placeholder="è«‹æè¿°é›»æ³³è† åœ–è³‡è¨Šæˆ–ä¸Šå‚³åœ–ç‰‡é€£çµ"
                    />
                  </div>
                </div>
              )}
              
              {formData.sampleType !== 'Library'  && formData.sampleType !== 'ç„¡é€æ¨£' && (
                <div className="col-span-2 mt-4 border-2 border-green-300 rounded-lg p-6 bg-green-50">
                  <h4 className="text-lg font-bold text-gray-800 mb-4">{formData.sampleType} é€ä»¶è³‡è¨Š</h4>
                  
                  <div className="mb-4 text-xs text-gray-500 bg-yellow-50 p-2 rounded border border-yellow-200">
                    ğŸ’¡ æç¤ºï¼š
                    <br/>â€¢ Sample_Name å‹¿ç”¨æ•¸å­—é–‹é ­ï¼Œä¸èƒ½ç©ºæ ¼ï¼Œåƒ…å…è¨±"-"ã€"_"ç¬¦è™Ÿ
                    <br/>â€¢ æ¸¬å®šæ–¹æ³•è«‹é¸æ“‡ Qubit æˆ– Nanodrop
                    <br/>â€¢ é»æ“Šè¡¨æ ¼ä»»ä¸€å„²å­˜æ ¼å¾ŒæŒ‰ Ctrl+V è²¼ä¸Šï¼Œç³»çµ±æœƒè‡ªå‹•æ–°å¢è¡Œæ•¸
                  </div>

                  <div className="flex items-center justify-between mb-3">
                    <h5 className="font-semibold text-gray-700">æ¨£æœ¬è³‡è¨Š</h5>
                    <button
                      type="button"
                      onClick={addSampleSheetRow}
                      className="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-blue-100 border border-blue-300"
                    >
                      <Plus size={14} />
                      æ–°å¢æ¨£æœ¬
                    </button>
                  </div>

                  <div className="overflow-x-auto">
                    <table className="w-full text-sm border-collapse">
                      <thead>
                        <tr className="bg-gray-100">
                          <th className="border p-2">åºè™Ÿ</th>
                          <th className="border p-2">Sample_Name*</th>
                          <th className="border p-2">Tube Label*</th>
                          <th className="border p-2">é æœŸå®šåºé‡</th>                        
                          <th className="border p-2">Conc* (ng/ul)</th>
                          <th className="border p-2">Vol* (uL)</th>
                          <th className="border p-2">260/280</th>
                          <th className="border p-2">260/230</th>
                          <th className="border p-2">DQN/RQN</th>
                          <th className="border p-2">å‚™è¨»</th>
                          <th className="border p-2">æ“ä½œ</th>
                        </tr>
                      </thead>
                      <tbody onPaste={(e) => handleSampleTablePaste(e, 0)}>
                        {formData.sampleInfo.sampleSheet.map((row, idx) => (
                          <tr key={idx} className="bg-white">
                            <td className="border p-2 text-center">{idx + 1}</td>
                            <td className="border p-2">
                              <input
                                type="text"
                                value={row.sampleName}
                                onChange={(e) => handleSampleSheetChange(idx, 'sampleName', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                                placeholder="å‹¿ç”¨æ•¸å­—é–‹é ­"
                              />
                            </td>
                            <td className="border p-2">
                              <input
                                type="text"
                                value={row.tubeLabel}
                                onChange={(e) => handleSampleSheetChange(idx, 'tubeLabel', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              />
                            </td>
                            <td className="border p-2">
                              <input
                                type="text"
                                value={row.expectedSeq}
                                onChange={(e) => handleSampleSheetChange(idx, 'expectedSeq', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              />
                            </td>
 
                            <td className="border p-2">
                              <input
                                type="number"
                                value={row.conc}
                                onChange={(e) => handleSampleSheetChange(idx, 'conc', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              />
                            </td>
                            <td className="border p-2">
                              <input
                                type="number"
                                value={row.vol}
                                onChange={(e) => handleSampleSheetChange(idx, 'vol', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              />
                            </td>
                            <td className="border p-2">
                              <input
                                type="number"
                                step="0.01"
                                value={row.ratio260280}
                                onChange={(e) => handleSampleSheetChange(idx, 'ratio260280', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              />
                            </td>
                            <td className="border p-2">
                              <input
                                type="number"
                                step="0.01"
                                value={row.ratio260230}
                                onChange={(e) => handleSampleSheetChange(idx, 'ratio260230', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              />
                            </td>
                            <td className="border p-2">
                              <input
                                type="number"
                                step="0.1"
                                value={row.dqnRqn}
                                onChange={(e) => handleSampleSheetChange(idx, 'dqnRqn', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              />
                            </td>
                            <td className="border p-2">
                              <input
                                type="text"
                                value={row.note}
                                onChange={(e) => handleSampleSheetChange(idx, 'note', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              />
                            </td>
                            <td className="border p-2 text-center">
                              {formData.sampleInfo.sampleSheet.length > 1 && (
                                <button
                                  type="button"
                                  onClick={() => removeSampleSheetRow(idx)}
                                  className="text-red-500 hover:text-red-700"
                                >
                                  <X size={16} />
                                </button>
                              )}
                            </td>
                          </tr>
                          
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
              ---
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  ä¿å­˜æ–¹å¼ <span className="text-red-600">*</span>
                </label>
                <select
                  name="preservationMethod"
                  value={formData.preservationMethod}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                >
                  <option>Nuclease-free H2O</option>
                  <option>Tris Buffer</option>
                  <option>Trizol</option>
                  <option>EDTA Tube(Blood)</option>
                  <option>Tempus Tube(Blood)</option>
                  <option>å…¶ä»–</option>
                </select>
                {formData.preservationMethod === 'å…¶ä»–' && (
                  <input
                    type="text"
                    name="preservationMethodOther"
                    value={formData.preservationMethodOther}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 mt-2"
                    placeholder="è«‹èªªæ˜ä¿å­˜æ–¹å¼"
                  />
                )}
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  æ¨£å“æ•¸é‡ <span className="text-red-600">*</span>
                </label>
                <input
                  type="number"
                  name="sampleCount"
                  value={formData.sampleCount}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                  min="1"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  ç‰©ç¨® <span className="text-red-600">*</span>
                </label>
                <select
                  name="species"
                  value={formData.species}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                >
                  <option>ç‰©ç¨®è«‹é¸æ“‡</option>
                  <option>Human</option>
                  <option>Mouse</option>
                  <option>Rat</option>
                  <option>å…¶ä»–</option>
                </select>
                {formData.species === 'å…¶ä»–' && (
                  <input
                    type="text"
                    name="speciesOther"
                    value={formData.speciesOther}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 mt-2"
                    placeholder="è«‹èªªæ˜ç‰©ç¨®"
                  />
                )}
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  å¯„é€æ–¹å¼ <span className="text-red-600">*</span>
                </label>
                <select
                  name="shippingMethod"
                  value={formData.shippingMethod}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                >
                  <option>å†·å‡(ä¹¾å†°)</option>
                  <option>å†·è—</option>
                  <option>å¸¸æº«</option>
                  <option>å…¶ä»–</option>
                </select>
                {formData.shippingMethod === 'å…¶ä»–' && (
                  <input
                    type="text"
                    name="shippingMethodOther"
                    value={formData.shippingMethodOther}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 mt-2"
                    placeholder="è«‹èªªæ˜å¯„é€æ–¹å¼"
                  />
                )}
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  æ¨£æœ¬è¿”é‚„
                </label>
                <select
                  name="sampleReturn"
                  value={formData.sampleReturn}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                >
                  <option>ä¸éœ€è¦</option>
                  <option>ä»£å¯„(é‹è²»è‡ªä»˜)</option>
                  <option>è‡ªå– (çµæ¡ˆä¸€å€‹æœˆå…§è‡ªå–ï¼Œé€¾æœŸéŠ·æ¯€)</option>
                </select>
              </div>
              <div className="col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  å‚™è¨»
                </label>
                <textarea
                  name="notes"
                  value={formData.notes}
                  onChange={handleInputChange}
                  rows={3}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                />
              </div>
            </div>
          </div>

          {/* å§”è¨—äººç°½åç¢ºèª */}
          <div className="border-2 border-gray-400 rounded-lg p-6 bg-white shadow-md">
            <h3 className="text-xl font-bold text-gray-800 mb-6 pb-3 border-b-2 border-gray-300">
              å§”è¨—äººç°½åç¢ºèª <span className="text-red-600">*</span>
            </h3>
            <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 border-2 border-blue-200">
              {!formData.signature ? (
                <div className="text-center py-8">
                  <div className="mb-4">
                    <Edit3 size={48} className="mx-auto text-blue-600" />
                  </div>
                  <p className="text-gray-700 mb-2 font-medium">è«‹ç°½åç¢ºèªè¨‚å–®å…§å®¹ç„¡èª¤</p>
                  <p className="text-sm text-gray-500 mb-6">
                    æ”¯æ´æ‰‹å¯«ç°½å âœï¸ æˆ–ä¸Šå‚³åœ–ç‰‡ ğŸ“¤
                  </p>
                  <button
                    type="button"
                    onClick={() => setShowSignaturePad(true)}
                    className="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-md hover:shadow-lg"
                  >
                    <Edit3 size={20} />
                    é–‹å§‹ç°½å
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                    <p className="text-green-600 font-semibold flex items-center gap-2 text-lg">
                      <Check size={24} />
                      å·²å®Œæˆç°½å
                    </p>
                    <div className="flex gap-2">
                      <button
                        type="button"
                        onClick={() => setShowSignaturePad(true)}
                        className="px-4 py-2 text-sm border-2 border-blue-300 text-blue-700 rounded-lg hover:bg-blue-50 transition"
                      >
                        é‡æ–°ç°½å
                      </button>
                      <button
                        type="button"
                        onClick={clearSignature}
                        className="px-4 py-2 text-sm text-red-600 border-2 border-red-300 rounded-lg hover:bg-red-50 transition"
                      >
                        æ¸…é™¤ç°½å
                      </button>
                    </div>
                  </div>
                  <div className="border-2 border-gray-300 rounded-lg p-4 bg-white shadow-sm">
                    <img 
                      src={formData.signature} 
                      alt="å§”è¨—äººç°½å" 
                      className="max-w-full h-auto mx-auto"
                      style={{ maxHeight: '150px' }}
                    />
                  </div>
                  <p className="text-sm text-gray-600 text-center">
                    ğŸ“… ç°½åæ—¥æœŸï¼š{new Date().toLocaleDateString('zh-TW', { 
                      year: 'numeric', 
                      month: 'long', 
                      day: 'numeric' 
                    })}
                  </p>
                </div>
              )}
            </div>
          </div>

          {/* æäº¤æŒ‰éˆ• */}
          <div className="flex gap-4 pt-6 border-t">
            <button
              onClick={handleSubmit}
              className="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 font-medium shadow-md hover:shadow-lg"
            >
              <Send size={20} />
              æäº¤è¨‚å–®
            </button>
            <button
              onClick={exportToExcel}
              className="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2 font-medium shadow-md hover:shadow-lg"
            >
              <Download size={20} />
              åŒ¯å‡º Excel
            </button>
          </div>

          {/* è¨Šæ¯æç¤º */}
          {message && (
            <div className={`mt-4 p-4 rounded-lg flex items-center gap-2 ${
              submitted || message.includes('æˆåŠŸ') 
                ? 'bg-green-50 border border-green-200 text-green-800' 
                : 'bg-yellow-50 border border-yellow-200 text-yellow-800'
            }`}>
              <AlertCircle size={20} />
              <span>{message}</span>
            </div>
          )}
        </div>
      </div>
      
      {/* ç°½åæ¿å½ˆçª— */}
      {showSignaturePad && (
        <SignaturePad
          title="å§”è¨—äººç°½åç¢ºèª"
          onSave={handleSignatureSave}
          onCancel={handleSignatureCancel}
        />
      )}

      {/* è²¼ä¸Šè³‡æ–™ Modal */}
      {showPasteModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full">
            <div className="border-b px-6 py-4 flex items-center justify-between">
              <h3 className="text-lg font-semibold text-gray-800">å¾ Excel è²¼ä¸Šè³‡æ–™</h3>
              <button 
                onClick={() => {
                  setShowPasteModal(false);
                  setPasteData('');
                }} 
                className="text-gray-400 hover:text-gray-600 transition"
              >
                <X size={24} />
              </button>
            </div>
            
            <div className="p-6">
              <div className="mb-4">
                <p className="text-sm text-gray-600 mb-2">
                  ğŸ“‹ è«‹åœ¨ Excel ä¸­é¸æ“‡è³‡æ–™ï¼ˆåŒ…å«æ¨™é¡Œè¡Œï¼‰ï¼Œç„¶å¾ŒæŒ‰ Ctrl+C è¤‡è£½ï¼Œå†è²¼åˆ°ä¸‹æ–¹æ–‡å­—æ¡†ä¸­
                </p>
                {pasteMode === 'sampleSheet' ? (
                  <p className="text-xs text-gray-500">
                    æ ¼å¼ï¼šåºè™Ÿ | Sample_Name | Tube Label | Conc (ng/ul) | Vol (uL) | NGSä¸Šæ©Ÿæ¿ƒåº¦ (pM) | é æœŸå®šåºé‡ | å‚™è¨»
                  </p>
                ) : (
                  <p className="text-xs text-gray-500">
                    æ ¼å¼ï¼šåºè™Ÿ | Sample_Name | Library Prep Kit | Index Adapter Kit | Set-Well Position | Index 1 (i7) | Index 2 (i5) | å‚™è¨» | Library
                  </p>
                )}
              </div>
              
              <textarea
                value={pasteData}
                onChange={(e) => setPasteData(e.target.value)}
                placeholder="è«‹åœ¨æ­¤è²¼ä¸Šå¾ Excel è¤‡è£½çš„è³‡æ–™..."
                rows={10}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 font-mono text-sm"
              />
            </div>
            
            <div className="border-t px-6 py-4 flex gap-3 justify-end">
              <button
                onClick={() => {
                  setShowPasteModal(false);
                  setPasteData('');
                }}
                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
              >
                å–æ¶ˆ
              </button>
              <button
                onClick={handlePasteData}av
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
              >
                <Check size={18} />
                ç¢ºèªåŒ¯å…¥
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default TGIAOrderForm;